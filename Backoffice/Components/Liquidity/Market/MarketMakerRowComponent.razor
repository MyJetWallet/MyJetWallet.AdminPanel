@using Service.Liquidity.Engine.Domain.Models.Settings
@using Backoffice.Components.Liquidity.Market.Models
@using MyJetWallet.Domain.Prices
@using Service.Liquidity.Engine.Domain.Models.Wallets
@using Service.MatchingEngine.PriceSource.Client

@inject ICurrentPricesCache PriceService

@implements IDisposable
        
<tr>
    <td>
        @Provider.Liquidity.InstrumentSymbol
    </td>
    <td>
        <MyLabel Color="@(Provider.Liquidity.Mode == EngineMode.Active ? "green":"red")" Text="@Provider.Liquidity.Mode.ToString()" />
    </td>
    <td>
        <MyLabel Color="@(Provider.Hedge.Mode == EngineMode.Active ? "green":"red")" Text="@Provider.Hedge.Mode.ToString()" />
    </td>
    
    <td>
        @if (_price != null)
        {
            <div style="font-size: 8px; background: @((DateTime.UtcNow - _price.DateTime).TotalSeconds>5 ? "lightpink" : "white")">
                <div class="row">
                    <div class="col-md-1">ask:</div>
                    <div class="col-md-1">@_price.Ask</div>
                </div>
                <div class="row">
                    <div class="col-md-1">bid:</div>
                    <div class="col-md-1">@_price.Bid</div>
                </div>
                <div class="row">
                    <div class="col-md-1">spred:</div>
                    <div class="col-md-1">@(Math.Round((_price.Ask-_price.Bid)/((_price.Ask+_price.Bid)/2)*100, 3))%</div>
                </div>
            </div>
        }
    </td>
    <td>
        @Provider.Liquidity.ExternalMarket
    </td>
    <td>
        @Provider.Liquidity.ExternalSymbol
    </td>
    <td>
        @Provider.Liquidity.Markup
    </td>
    <td>
        @Provider.WalletName    
    </td>
    
    <td>
        <ul class="nav">
            <li><button type="button" class="btn-outline-info btn" style="height: 20px; font-size: 10px" @onclick="ClickDetails" >...</button></li>
        </ul>
    </td>
    
</tr>    
@if (IsActiveRow)
{
    <tr>
        <td colspan="8">
            <InstrumentDetailsComponent Provider="@Provider" LpWallets="@LpWallets" UpdateCallback="UpdateCallback" />
        </td>
    </tr>
}
        
@code {

    [Parameter]
    public bool IsActiveRow { get; set; }
    
    [Parameter]
    public InstrumentLpSettings Provider { get; set; }
    
    [Parameter]
    public Func<InstrumentLpSettings, Task<bool>> UpdateCallback { get; set; }
    
    [Parameter]
    public List<LpWallet> LpWallets { get; set; }

    private BidAsk _price { get; set; }
    private bool IsDispose = false;
    
    private void ClickDetails()
    {
        IsActiveRow = !IsActiveRow;
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await RefreshPrice();
        
        GlobalTimers.RefreshTimer.RegisterCallback($"Price MM {Provider.Symbol}; {Provider.WalletId}", RefreshPrice);
    }

    private async Task RefreshPrice()
    {
        if (IsDispose) return;
        
        if (Provider.Wallet != null)
        {
            _price = PriceService.GetPrice(Provider.Wallet.BrokerId, Provider.Symbol);
        }

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        IsDispose = true;
        GlobalTimers.RefreshTimer.RemoveCallback($"Price MM {Provider.Symbol}; {Provider.WalletId}");
    }

}