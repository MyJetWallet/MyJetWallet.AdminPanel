@using Service.SmsSender.Domain.Models
@using Service.SmsSender.Grpc
@using Backoffice.Abstractions.Models
@using System.Threading
@using Backoffice.Extensions

@inject ISmsTemplateService SmsTemplateService
@inject IToaster ToastService

<Loader LoaderConfig="@LoaderConfig" />

<ul class="nav float-left">
    <li><button @onclick="OnRefresh" type="button" class="btn btn-outline-primary" style="margin: 5px; border-radius: 10px">Refresh</button></li>
</ul>
<div class="row">
    <table class="table" style="width: auto">
        <thead>
            <tr>
                <th>Template</th>
                <th>Default brand</th>
                <th>Default lang</th>
                @foreach (var brand in Brands)
                {
                    <th>@brand</th>
                }
                <th></th>
            </tr>
        </thead>
        <tbody>
        @foreach (var template in TemplatesList)
        {
            <TemplatesTableRow Template="@template" Brands="@Brands" LoaderConfig="@LoaderConfig" />
        }
        </tbody>
    </table>
</div>

@code {

    private ILoaderConfiguration LoaderConfig { get; set; } = new LoaderConfiguration();
    private SmsTemplate[] TemplatesList { get; set; } = Array.Empty<SmsTemplate>();
    private SmsTemplate SelectedTemplate { get; set; }
    private List<string> Brands { get; set; } = new();

    private bool IsShowAdding { get; set; }
    private const int MAX_ATTEMPTS_COUNT = 3;

    private async void OnRefresh()
    {
        LoaderConfig.Enable();

        await LoadTemplatesAsync();

        LoaderConfig.Disable();

        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadTemplatesAsync()
    {
        var attempts = 0;
        var exceptionMessage = string.Empty;

        while (attempts < MAX_ATTEMPTS_COUNT)
        {
            try
            {
                var templatesResponse = await SmsTemplateService.GetAllTemplatesAsync();
                TemplatesList = templatesResponse?.Templates;

                if (TemplatesList != null)
                {
                    foreach (var template in TemplatesList)
                    {
                        var filteredLangBodies = new Dictionary<string, string>();
                        foreach (var brandLangBody in template.BrandLangBodies)
                        {
                            var defaultLangBody = brandLangBody.LangBodies
                            .FirstOrDefault(b => b.Key == template.DefaultLang.ToString()).Value;

                            filteredLangBodies.Add(template.DefaultLang.ToString(), defaultLangBody);
                            filteredLangBodies.AddRange(brandLangBody.LangBodies.Where(b => b.Value != defaultLangBody));
                            brandLangBody.LangBodies = filteredLangBodies;

                            Brands.Add(brandLangBody.Brand);
                        }
                    }
                }

                break;
            }
            catch (Exception ex)
            {
                exceptionMessage = ex.Message;
                attempts++;
            }

            Thread.Sleep(1000);
        }

        if (attempts == MAX_ATTEMPTS_COUNT)
        {
            ToastService.Error(exceptionMessage, "Cannot get any templates.");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        LoaderConfig.Enable();

        await LoadTemplatesAsync();

        LoaderConfig.Disable();

        await base.OnInitializedAsync();
    }

}