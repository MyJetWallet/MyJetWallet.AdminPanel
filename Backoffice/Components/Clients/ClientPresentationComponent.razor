@using Backoffice.Components.Clients.Model
@using Backoffice.Components.Converter.History
@using MyJetWallet.Domain
@using Service.ClientWallets.Domain.Models
@using Service.ClientWallets.Grpc

@inject IClientWalletService _walletService

@if (Client != null)
{
    <table>
        <tr>
            <ClientInfoComponent Client="@Client"/>
        </tr>
        <tr>
            Client Wallets:
            <ul class="nav nav-tabs nav-pills">
                @foreach (var wallet in Client.Wallets)
                {
                    <li class="nav-item" style="margin: 5px">
                        @if (ActiveWallet == wallet)
                        {
                            <button class="page-link" style="color: #1b1e21; background: lightskyblue" @onclick="@(() => SetWallet(wallet))">
                                <span>@wallet.Name</span>
                                @if (wallet.IsDefault)
                                {
                                    <span> (*)</span>
                                }
                            </button>
                        }
                        else
                        {
                            <button class="page-link" style="color: #1b1e21" @onclick="@(() => SetWallet(wallet))">
                                <span>@wallet.Name</span>
                                @if (wallet.IsDefault)
                                {
                                    <span> (*)</span>
                                }
                            </button>
                        }
                    </li>                    
                }
            </ul>
        </tr>

            <tr>
                <ul class="nav nav-tabs nav-pills">
                    @if (ActiveWallet != null)
                    {
                        <li class="nav-item">
                            <button class="page-link" style="@(GetMenuStyle(ClientPage.WalletInfo))" aria-current="page" @onclick="@(() => SetPage(ClientPage.WalletInfo))">Wallet Info</button>
                        </li>
                        <li class="nav-item">
                            <button class="page-link" style="@(GetMenuStyle(ClientPage.Balances))" aria-current="page" @onclick="@(() => SetPage(ClientPage.Balances))">Balances</button>
                        </li>
                        <li class="nav-item">
                            <button class="page-link" style="@(GetMenuStyle(ClientPage.BalanceHistory))" aria-current="page" @onclick="@(() => SetPage(ClientPage.BalanceHistory))">Balance History</button>
                        </li>
                        <li class="nav-item">
                            <button class="page-link" style="@(GetMenuStyle(ClientPage.SwapHistory))" @onclick="@(() => SetPage(ClientPage.SwapHistory))">Swap History</button>
                        </li>
                        <li class="nav-item">
                            <button class="page-link" style="@(GetMenuStyle(ClientPage.QuoteHistory))" @onclick="@(() => SetPage(ClientPage.QuoteHistory))">Quote History</button>
                        </li>
                        <li class="nav-item">
                            <button class="page-link" style="@(GetMenuStyle(ClientPage.BlockchainDepositAddress))" @onclick="@(() => SetPage(ClientPage.BlockchainDepositAddress))">Blockchain Addresses</button>
                        </li>
                    }
                    <li class="nav-item">
                        <button class="page-link" style="@(GetMenuStyle(ClientPage.Sessions))" @onclick="@(() => SetPage(ClientPage.Sessions))">Sessions</button>
                    </li>
                    <li class="nav-item">
                        <button class="page-link" style="@(GetMenuStyle(ClientPage.Notifications))" @onclick="@(() => SetPage(ClientPage.Notifications))">Notification History</button>
                    </li>
                    <li class="nav-item">
                        <button class="page-link" style="@(GetMenuStyle(ClientPage.Notifications))" @onclick="@(() => SetPage(ClientPage.Profile))">Client Profile</button>
                    </li>
                </ul>
            </tr>
            <tr>
                <div style="margin: 20px">
                    <CascadingValue Value="@ActiveWallet" Name="Wallet">
                    @switch (ActivePage)
                    {
                        case ClientPage.WalletInfo:
                            <WalletInfoComponent Wallet = "@ActiveWallet"/>
                            break;
                            
                        case ClientPage.Balances:
                            <ClientBalancesComponent/>
                            break;

                        case ClientPage.BalanceHistory:
                            <ClientBalanceHistoryComponent/>
                            break;

                        case ClientPage.SwapHistory:
                            <ClientSwapHistoryComponent />
                            break;
                            
                        case ClientPage.QuoteHistory:
                            <ConverterHistoryComponent WalletId="@ActiveWallet.WalletId" />
                            break;

                        case ClientPage.BlockchainDepositAddress:
                            <ClientBlockchainDepositAddressComponent ClientId="@Client.ClientId" BrokerId="@Client.BrokerId"  WalletId="@ActiveWallet.WalletId" />
                            break;
                            
                        case ClientPage.Sessions:
                            <ClientSessionsComponent ClientId="@Client.ClientId"/>
                            break;
                            
                        case ClientPage.Notifications:
                            <NotificationHistoryComponent ClientId="@ClientId"/>
                            break;
                            
                        case ClientPage.Profile:
                            <ClientProfileComponent ClientId="@ClientId"/>
                            break;
                    }
                    </CascadingValue>
                </div>

            </tr>
    </table>
}


@code {
    [Parameter]
    public string BrokerId { get; set; }
    
    [Parameter]
    public string BrandId { get; set; }
    
    [Parameter]
    public string ClientId { get; set; }
    
    [Parameter]
    public string WalletId { get; set; }
    
    [Parameter]
    public string Email { get; set; }
    
    [Parameter]
    public bool EmailConfirmed { get; set; }
    
    [Parameter]
    public string Phone { get; set; }
    
    [Parameter]
    public bool PhoneConfirmed { get; set; }

    private ClientPage ActivePage { get; set; }

    private ClientModel Client { get; set; }
    
    private WalletModel ActiveWallet { get; set; }

    private void SetPage(ClientPage page)
    {
        ActivePage = page;
        StateHasChanged();
    }
    
    private void SetWallet(WalletModel wallet)
    {
        ActiveWallet = wallet;
        StateHasChanged();
    }


    private enum ClientPage
    {
        None,
        WalletInfo,
        Balances,
        BalanceHistory,
        SwapHistory,
        QuoteHistory,
        BlockchainDepositAddress,
        Sessions,
        Notifications,
        Profile
    }


    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(ClientId))
            return;

        Client = new ClientModel(BrokerId, ClientId, BrandId, EmailConfirmed, Email, PhoneConfirmed, Phone);
        Client.Wallets = new List<WalletModel>();
        
        if (!string.IsNullOrWhiteSpace(BrokerId) && !string.IsNullOrWhiteSpace(BrandId) && !string.IsNullOrWhiteSpace(ClientId))
        {
            var wallets = await _walletService.GetWalletsByClient(new JetClientIdentity(BrokerId, BrandId, ClientId));

            Client.Wallets = wallets.Wallets
                .Select(e => new WalletModel(e.Name, BrokerId, ClientId, BrandId, e.WalletId, e.IsDefault, e.BaseAsset, e.CreatedAt))
                .ToList();
        }
        
        ActiveWallet = null;
        
        if (!string.IsNullOrEmpty(WalletId))
        {
            ActiveWallet = Client.Wallets.FirstOrDefault(e => e.WalletId == WalletId);
        }

        ActiveWallet ??= Client.Wallets.FirstOrDefault();
    }

    private string GetMenuStyle(ClientPage page)
    {
        if (ActivePage == page)
        {
            return "background: lightblue";
        }

        return "";
    }

}