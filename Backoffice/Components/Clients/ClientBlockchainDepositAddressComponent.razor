@using Backoffice.Components.Clients.Model
@using Microsoft.Extensions.Logging
@using Service.BalanceHistory.Domain.Models
@using Service.BalanceHistory.Grpc
@using Service.BalanceHistory.Grpc.Models
@using Backoffice.Abstractions.Models
@using Backoffice.Services.Assets
@using MyNoSqlServer.Abstractions
@using Service.AssetsDictionary.Client
@using Service.Bitgo.DepositDetector.Domain.Models
@using Service.Bitgo.DepositDetector.Grpc
@using Service.Bitgo.DepositDetector.NoSql

@inject IBitgoDepositAddressService _addressService;
@inject IMyNoSqlServerDataReader<DepositAddressEntity> _addressReader;
@inject IAssetItemManager _assetItemManager; 
@inject ILogger<ClientBlockchainDepositAddressComponent> _logger
@inject IToaster Toaster


<h3>Deposit Addresses</h3>

    <ul class="nav">
        <li><button type="button" class="btn-outline-secondary btn" @onclick="Refresh">Refresh</button></li>
    </ul>
    <table class="table" style="font-size: 12px; width: auto">

        <thead>
        <tr>
            <th>Asset</th>
            <th>Address</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var (asset, address) in DepositAddresses)
        {
            <tr>
                <td>@asset</td>
                <td>@address</td>
                @if (string.IsNullOrWhiteSpace(address))
                {
                    <td><button class="btn btn-outline-success" @onclick="async () => {await GenerateNewAddress(asset); }" type="button">Generate new address</button></td>
                }
            </tr>
        }
        </tbody>
    </table>


@code {
    
    [Parameter]
    public string BrokerId { get; set; }
    
    [Parameter]
    public string ClientId { get; set; }
    
    [Parameter]
    public string WalletId { get; set; }
    private Dictionary<string, string> DepositAddresses { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await Refresh();
    }

    private async Task Refresh()
    {
        DepositAddresses = new();
        var assets = await _assetItemManager.GetAll();
        foreach (var asset in assets)
        {
            try
            {
                var addressEntity = _addressReader.Get(DepositAddressEntity.GeneratePartitionKey(WalletId), DepositAddressEntity.GenerateRowKey(asset.Asset.Symbol));
                DepositAddresses.Add(asset.Asset.Symbol, addressEntity?.Address);
            }
            catch (Exception e)
            {
                _logger.LogError(e, "When getting deposit address for user {clientId}, asset {asset}", ClientId, asset.Asset);
                DepositAddresses.Add(asset.Asset.Symbol, null);
            }
        }
    }

    private async Task GenerateNewAddress(string asset)
    {
        try
        {
            var response = await _addressService.GetDepositAddressAsync(new GetDepositAddressRequest()
            {
                AssetSymbol = asset,
                WalletId = WalletId,
                BrokerId = BrokerId,
                ClientId = ClientId
            });
            
            if (response.Error == GetDepositAddressResponse.ErrorCode.Ok)
                DepositAddresses[asset] = response.Address;
            else
                Toaster.Error($"Unable to create deposit address for {asset}");
            
            StateHasChanged();
        }
        catch (Exception e)
        {
            _logger.LogError(e, "When getting deposit address for user {clientId}, asset {asset}", ClientId, asset);
            Toaster.Error($"Unable to create deposit address for {asset}");
        }
    }
}