@using Backoffice.Components.Clients.Model
@using Backoffice.Abstractions.Models
@using ME.Contracts.OutgoingMessages
@using Microsoft.Extensions.Logging
@using Service.BalanceHistory.Domain.Models
@using Service.BalanceHistory.Grpc
@using Service.BalanceHistory.Grpc.Models

@inject IWalletTradeService _tradeService
@inject ILogger<ClientTradeHistoryComponent> _logger

<Loader LoaderConfig="@LoaderConfig"/>

<h3>Trade History</h3>

<ul class="nav">
    @if (Trades?.Any() == true)
    {
        <li><button type="button" class="btn-outline-info btn" @onclick="NextPage">>>> Next >>></button></li>
    }
    <li><button type="button" class="btn-outline-secondary btn" @onclick="Refresh">Refresh</button></li>
    <li>Count in page: <input type="number" style="width: 40px" @bind="CountInPage"/></li>
</ul>
<table class="table" style="font-size: 12px; width: auto">
    <thead>
    <tr>
        <th>#</th>
        <th>DateTime</th>
        <th>Symbol</th>
        <th>Type</th>
        <th>Side</th>
        <th>Price</th>
        <th>Volume</th>
        <th>TradeUId</th>
        <th>OrderId</th>
    </tr>
    </thead>
    <tbody>

    @foreach (var item in Trades)
    {
        <tr>
            <td>@item.Index</td>
            <td>@item.Trade.DateTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
            <td>@item.Trade.InstrumentSymbol</td>
            <td>@item.Trade.Type.ToString()</td>
            <td>@item.Trade.Side.ToString()</td>
            <td>@item.Trade.Price</td>
            <td>@item.Trade.BaseVolume</td>
            <td>@item.Trade.TradeUId</td>
            <td>@item.Trade.OrderId</td>
        </tr>
    }
    </tbody>
</table>




@code {
    
    [CascadingParameter(Name = "Wallet")]
    public WalletModel Wallet { get; set; }
    
    private ILoaderConfiguration LoaderConfig { get; set; } = new LoaderConfiguration();
    
    private int CountInPage { get; set; } = 20;
    private long? _lastSequenceId = null;
    private long _index = 0;

    private List<Item> Trades { get; set; } = new();
    
    protected override async Task OnInitializedAsync()
    {
        await Refresh();
    }
    
    private Task Refresh()
    {
        _index = 0;
        _lastSequenceId = null;
        Trades = new List<Item>();
        return NextPage();
    }
    
    private async Task NextPage()
    {
        try
        {
            LoaderConfig.Enable();
            StateHasChanged();
            
            _lastSequenceId = Trades.LastOrDefault()?.Trade.SequenceId;

            var data = await _tradeService.GetTradesAsync(new GetTradesRequest()
            {
                WalletId = Wallet.WalletId,
                Take = CountInPage,
                LastSequenceId = _lastSequenceId
            });
            
            Trades = (data.Trades ?? new List<WalletTrade>()).Select(e => new Item()
            {
                Index = ++_index,
                Trade = e
            }).ToList();
            
            LoaderConfig.Disable();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Cannot execute NextPage");
        }
    }

    public class Item
    {
        public WalletTrade Trade { get; set; }
        public long Index { get; set; }
    }

}